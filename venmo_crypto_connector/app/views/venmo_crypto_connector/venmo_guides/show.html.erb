<!DOCTYPE html>
<html>
<head>
  <title><%= @guide.title %> - Venmo Crypto Connector</title>
  <meta name="csrf-token" content="<%= form_authenticity_token %>">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f7; }
    .container { max-width: 800px; margin: 0 auto; }
    .guide-header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .progress-bar { background: #e5e5e7; height: 8px; border-radius: 4px; overflow: hidden; margin: 10px 0; }
    .progress-fill { background: #007AFF; height: 100%; transition: width 0.3s ease; }
    .step-indicator { display: flex; justify-content: space-between; margin: 20px 0; }
    .step-dot { width: 12px; height: 12px; border-radius: 50%; background: #e5e5e7; }
    .step-dot.active { background: #007AFF; }
    .step-dot.completed { background: #34C759; }
    .guide-content { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .screenshot-container { position: relative; margin: 20px 0; }
    .guide-screenshot { width: 100%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .screenshot-annotations { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .annotation { position: absolute; background: rgba(255, 59, 48, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .guide-video { width: 100%; max-width: 500px; border-radius: 8px; }
    .alert { padding: 15px; border-radius: 8px; margin: 15px 0; }
    .alert-danger { background: #FFE5E5; border: 1px solid #FF3B30; color: #D70015; }
    .alert-warning { background: #FFF4E5; border: 1px solid #FF9500; color: #CC5500; }
    .checklist { margin: 20px 0; }
    .checklist-item { display: flex; align-items: center; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; }
    .checklist-item input[type="checkbox"] { margin-right: 10px; }
    .guide-navigation { display: flex; justify-content: space-between; align-items: center; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; }
    .btn-primary { background: #007AFF; color: white; }
    .btn-secondary { background: #8E8E93; color: white; }
    .btn-success { background: #34C759; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <div class="guide-header">
      <h1><%= @guide.title %></h1>
      <p><%= @guide.description %></p>
      
      <div class="progress-bar">
        <div class="progress-fill" style="width: <%= @current_step&.progress_percentage || 0 %>%"></div>
      </div>
      <p><strong>Step <%= @current_step&.step_number || 0 %> of <%= @guide.total_steps %></strong></p>
      
      <div class="step-indicator">
        <% @steps.each_with_index do |step, index| %>
          <div class="step-dot <%= 'active' if step == @current_step %> <%= 'completed' if index < @current_step_index %>"></div>
        <% end %>
      </div>
    </div>

    <% if @current_step %>
      <div class="guide-content">
        <h2><%= @current_step.title %></h2>
        
        <% if @current_step.screenshot? %>
          <div class="screenshot-container">
            <%= image_tag @current_step.image_url || '/assets/placeholder-phone.png', 
                          alt: @current_step.title, 
                          class: 'guide-screenshot' %>
            <% if @current_step.annotations.present? %>
              <div class="screenshot-annotations">
                <% @current_step.annotations.each do |annotation| %>
                  <div class="annotation" 
                       style="top: <%= annotation['top'] %>%; left: <%= annotation['left'] %>%;">
                    <%= annotation['text'] %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% elsif @current_step.video_clip? %>
          <video controls class="guide-video">
            <source src="<%= @current_step.video_url %>" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        <% elsif @current_step.warning? %>
          <div class="alert alert-danger">
            <strong>⚠️ Important:</strong> <%= simple_format @current_step.content %>
          </div>
        <% end %>
        
        <% if @current_step.instructions.present? %>
          <div class="step-instructions">
            <%= simple_format @current_step.instructions %>
          </div>
        <% end %>
        
        <% if @current_step.checklist? && @current_step.checklist_items.present? %>
          <div class="checklist">
            <h3>Checklist:</h3>
            <% @current_step.checklist_items.each do |item| %>
              <label class="checklist-item">
                <input type="checkbox" data-item="<%= item %>">
                <%= item %>
              </label>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <div class="guide-navigation">
        <div>
          <% unless @current_step.is_first_step? %>
            <%= link_to '← Previous Step', 
                        venmo_guide_path(@guide, step: @current_step.sequence - 1), 
                        class: 'btn btn-secondary' %>
          <% end %>
        </div>
        
        <div>
          <% if @current_step.is_last_step? %>
            <%= button_to 'Complete Guide', 
                          complete_venmo_guide_path(@guide), 
                          class: 'btn btn-success',
                          method: :post %>
          <% else %>
            <%= link_to 'Next Step →', 
                        venmo_guide_path(@guide, step: @current_step.sequence + 1), 
                        class: 'btn btn-primary' %>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="guide-content">
        <h2>Guide Complete!</h2>
        <p>You have successfully completed the <%= @guide.title %> guide.</p>
        <p>You earned <strong><%= @guide.xp_reward %> XP</strong>!</p>
        <%= link_to 'Back to Dashboard', dashboard_path, class: 'btn btn-primary' %>
      </div>
    <% end %>
  </div>

  <script>
    // Track checklist completion
    document.addEventListener('DOMContentLoaded', function() {
      const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const allChecked = Array.from(checkboxes).every(cb => cb.checked);
          const nextButton = document.querySelector('.btn-primary');
          if (nextButton && allChecked) {
            nextButton.style.background = '#34C759';
          }
        });
      });
    });
  </script>
</body>
</html>
